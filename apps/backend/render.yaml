services:
  - type: web
    name: vah-api-staging
    rootDir: .
    env: node
    plan: starter
    autoDeploy: true
    buildFilter:
      ignoredPaths:
        - apps/frontend/**
        - packages/**
        - .github/**
        - content/**
        - migrations/**
        - '*.md'
        - .gitignore
        - .npmrc
        - .pre-commit-config.yaml
        - .secrets.baseline
        - turbo.json
        - tsconfig.base.json
    buildCommand: |
      npm ci
      npm run build
    startCommand: npm run start
    healthCheckPath: /api/healthz
    disk:
      name: vah-data
      mountPath: /var/data
      sizeGB: 5
    envVars:
      - key: NODE_VERSION
        value: "20.19.0"
      - key: NODE_ENV
        value: production
      - key: APP_ORIGIN
        value: https://api.virtualaddresshub.co.uk
      - key: DATA_DIR
        value: /var/data
      - key: INVOICES_DIR
        value: /var/data/invoices
      - key: BACKUPS_DIR
        value: /var/data/backups
      - key: INVOICE_LINK_TTL_USER_MIN
        value: "30"
      - key: INVOICE_LINK_TTL_ADMIN_MIN
        value: "60"
      - key: ALLOWED_ORIGINS
        value: "https://vah-frontend-final.vercel.app,http://localhost:3000"
      # Set these in Render Dashboard (leave unsynced here if you prefer):
      - key: POSTMARK_API_TOKEN
        sync: false
      - key: POSTMARK_FROM
        sync: false
      - key: COOKIE_SECRET
        sync: false
      - key: GO_CARDLESS_SECRET
        sync: false
      - key: SUMSUB_SECRET
        sync: false

  - type: web
    name: vah-frontend
    rootDir: app
    env: node
    buildCommand: npm ci && npm run build
    startCommand: npm run start
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_BASE_URL
        value: https://www.virtualaddresshub.co.uk
      - key: BACKEND_API_ORIGIN
        value: https://api.virtualaddresshub.co.uk/api

  - type: cron
    name: onedrive-mail-ingest
    rootDir: .
    env: node
    # Runs every 1 minute: "* * * * *" (minute hour day month weekday)
    # To change interval: "*/2 * * * *" = every 2 min, "*/5 * * * *" = every 5 min, "*/10 * * * *" = every 10 min
    schedule: "* * * * *"
    buildCommand: |
      npm ci
      npm run build
    runCommand: cd apps/backend && node dist/src/workers/onedriveMailIngest.js
    envVars:
      - key: NODE_VERSION
        value: "20.19.0"
      - key: NODE_ENV
        value: production
      # Set these in Render Dashboard (leave unsynced here if you prefer):
      - key: MAIL_IMPORT_WEBHOOK_URL
        sync: false
      - key: MAIL_IMPORT_WEBHOOK_SECRET
        sync: false
      - key: ONEDRIVE_MAIL_INBOX_FOLDER_ID
        sync: false
      - key: ONEDRIVE_USER_UPN
        sync: false
      - key: GRAPH_TENANT_ID
        sync: false
      - key: GRAPH_CLIENT_ID
        sync: false
      - key: GRAPH_CLIENT_SECRET
        sync: false
      # Note: DATABASE_URL, POSTMARK_API_KEY, APP_BASE_URL, OPS_ALERT_EMAIL
      # are needed by the BACKEND SERVICE (not the worker). The worker only
      # calls the webhook - it doesn't access the database or send emails directly.

  - type: cron
    name: mailroom-expiry-reminders
    rootDir: .
    env: node
    # Runs daily at 2 AM UTC: "0 2 * * *" (minute hour day month weekday)
    # Sends expiry reminder emails to mailroom when mail items reach 30-day GDPR retention limit
    schedule: "0 2 * * *"
    buildCommand: |
      npm ci
      npm run build
    runCommand: cd apps/backend && node dist/src/scripts/mailroomExpiryReminders.js
    envVars:
      - key: NODE_VERSION
        value: "20.19.0"
      - key: NODE_ENV
        value: production
      # Note: DATABASE_URL, POSTMARK_API_TOKEN, MAILROOM_EMAIL are required
      # These should be set in Render Dashboard (shared with backend service)

  - type: cron
    name: log-destruction-to-excel
    rootDir: .
    env: node
    # Runs every 15 minutes to log confirmed destructions to Excel
    # This cron ONLY logs items that have been manually marked as destroyed by an admin
    # It does NOT decide what to destroy - human decides, cron records
    schedule: "*/15 * * * *"
    buildCommand: |
      npm ci
      npm run build
    runCommand: cd apps/backend && node dist/src/scripts/logDestructionToExcel.js
    envVars:
      - key: NODE_VERSION
        value: "20.19.0"
      - key: NODE_ENV
        value: production
      # DATABASE_URL is needed by this script. Ensure it is set in Render Dashboard.
      # TODO: Add Microsoft Graph API credentials for Excel writing:
      # - AZURE_CLIENT_ID
      # - AZURE_CLIENT_SECRET
      # - AZURE_TENANT_ID
      # - ONEDRIVE_DESTRUCTION_LOG_PATH (e.g., "/Scanned_Mail/Destruction_Log.xlsx")
