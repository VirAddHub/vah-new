#!/usr/bin/env bash
set -e

echo "ğŸ”’ Running content guardrails..."

# Block edits to content source of truth (after initial setup)
if git diff --cached --name-only | grep -E 'src/content/' && ! git log --oneline -1 | grep -q "implement AI guardrails"; then
  echo "ğŸš« Content is locked. Edit via approved flow only."
  echo "   Content changes must go through: src/content/content.ts"
  exit 1
fi

# Block invented marketing phrases in UI files only
CHANGED=$(git diff --cached -U0 | tr -d '\r')

# Check only UI files for marketing claims
UI_FILES=$(git diff --cached --name-only | grep -E '\.(tsx|ts|jsx|js)$' | grep -v -E '(test|spec|content|pre-commit)' || true)

if [ -n "$UI_FILES" ]; then
  for file in $UI_FILES; do
    if git diff --cached "$file" | grep -Ei '\+.*(trusted by|#\s*users|millions of|award[- ]winning|world.?class|leading|premier|best|top-rated)'; then
      echo "ğŸš« Detected invented marketing claim in $file. Remove it."
      echo "   Use only content from src/content/content.ts"
      exit 1
    fi
    
    # Block PWA prompts and notification requests
    if git diff --cached "$file" | grep -Ei '\+.*(install.*app|enable.*notification|PWAInstallPrompt|NotificationPermission|beforeinstallprompt|ServiceWorkerRegistration)'; then
      echo "ğŸš« PWA install/notification prompts are disabled. Remove them."
      echo "   These features are not wanted in this application."
      exit 1
    fi
  done
fi

# Block duplicate/backup files (e.g., "File 2.tsx") - but allow deletions
if git diff --cached --name-only --diff-filter=A | grep -E ' 2\.(tsx|ts|jsx|js)$' >/dev/null; then
  echo "âŒ Backup-style files detected (\" 2.tsx\"). Please delete or rename."
  echo "   Git history is sufficient for backups - no need for duplicate files."
  exit 1
fi

echo "âœ… Content guardrails passed"