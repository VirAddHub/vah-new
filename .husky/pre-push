#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 Running API smoke before push…"

# Check if servers are running
if ! curl -sf http://localhost:4000/api/ready >/dev/null 2>&1; then
  echo "⚠️  Backend not running, starting servers..."
  npm run dev:all &
  DEV_PID=$!
  
  # Wait for servers
  echo "⏳ Waiting for servers to start..."
  npm run dev:wait
  
  # Run backend tests
  npm run test:api:backend || { 
    echo "❌ API backend checks failed"; 
    kill $DEV_PID 2>/dev/null || true;
    exit 1; 
  }
  
  # Clean up
  kill $DEV_PID 2>/dev/null || true
else
  echo "✅ Backend is running, running quick test..."
  npm run test:api:backend || { echo "❌ API backend checks failed"; exit 1; }
fi

echo "✅ All checks passed! Pushing..."
