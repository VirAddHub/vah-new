name: API Test Suite

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_TELEMETRY_DISABLED: 1
      DATABASE_URL: file:${{ github.workspace }}/data/app.db
      DB_PATH: ${{ github.workspace }}/data/app.db
      SQLITE_PATH: ${{ github.workspace }}/data/app.db
      PORT: 4000
      BACKEND_URL: http://localhost:4000

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Prepare database
        run: |
          mkdir -p data
          sqlite3 "$DB_PATH" ".read scripts/db-schema.sql"
          node scripts/migrate.cjs
          node scripts/seed.cjs
      
      - name: Start backend (dev mode)
        run: |
          nohup npm run dev:backend > backend.log 2>&1 &
          echo $! > backend.pid
      
      - name: Start web (dev mode)
        run: |
          nohup npm run dev:web > web.log 2>&1 &
          echo $! > web.pid
      
      - name: Wait for servers
        run: npx wait-on -t 180000 tcp:4000 http://localhost:3000/api/bff/ready
      
      - name: Smoke check
        run: |
          curl -fsS http://localhost:4000/api/ready
          curl -fsS http://localhost:3000/api/bff/ready
      
      - name: Run API tests
        run: npm run test:api
      
      - name: Cleanup
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
          fi
          if [ -f web.pid ]; then
            kill $(cat web.pid) 2>/dev/null || true
          fi
      
      - name: Print logs on failure
        if: failure()
        run: |
          echo '=== backend.log ==='
          tail -n 100 backend.log || true
          echo '=== web.log ==='
          tail -n 100 web.log || true