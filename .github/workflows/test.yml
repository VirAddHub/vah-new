name: Test Suite

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      DATABASE_URL: file:${{ github.workspace }}/data/app.db
      DB_PATH: ${{ github.workspace }}/data/app.db
      SQLITE_PATH: ${{ github.workspace }}/data/app.db
      PORT: 4000

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Prepare database
        run: |
          mkdir -p data
          sqlite3 "$DB_PATH" ".read scripts/db-schema.sql"
          node scripts/migrate.cjs
          node scripts/seed.cjs
      
      - name: Test password reset script
        run: |
          node scripts/reset-password.cjs admin@virtualaddresshub.co.uk TestPassword123!
      
      - name: Start backend
        run: |
          nohup npm run dev:backend > backend.log 2>&1 &
          echo $! > backend.pid
      
      - name: Wait for backend
        run: npx wait-on -t 60000 tcp:4000
      
      - name: Run backend tests
        run: npm run test:api:backend
      
      - name: Cleanup
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
          fi
      
      - name: Print logs on failure
        if: failure()
        run: |
          echo '=== backend.log ==='
          tail -n 100 backend.log || true
