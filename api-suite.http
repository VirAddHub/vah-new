### API Test Suite - Manual Testing
### This file mirrors the automated test suite for manual verification
### Make sure both servers are running: npm run dev

### Variables
@bff = http://localhost:3000/api/bff
@api = http://localhost:4000/api
@adminEmail = admin@virtualaddresshub.co.uk
@adminPass = Admin123!
@forwardAddress = Home, 1 Test St, AB1 2CD

### Cookie Jars (REST Client will remember these)
# @bffJar = .cookies.bff.txt
# @apiJar = .cookies.api.txt

### ========================================
### BACKEND TESTS (Express :4000)
### ========================================

### 1. Backend CSRF
GET {{api}}/csrf

### 2. Backend Login
POST {{api}}/auth/login
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "email": "{{adminEmail}}",
  "password": "{{adminPass}}"
}

### 3. Backend System Health
GET {{api}}/ready
GET {{api}}/health
GET {{api}}/healthz
GET {{api}}/metrics

### 4. Backend Core Business Logic
GET {{api}}/plans
GET {{api}}/profile
GET {{api}}/auth/whoami
GET {{api}}/billing
GET {{api}}/billing/invoices
GET {{api}}/payments
GET {{api}}/payments/subscriptions/status

### 5. Backend Mail Operations
GET {{api}}/mail-items
GET {{api}}/mail-search?q=hmrc&limit=5
GET {{api}}/notifications/unread

### 6. Backend Admin Operations
GET {{api}}/admin/users?limit=20
GET {{api}}/admin/mail-items?status=scanned&limit=20
GET {{api}}/admin/plans
GET {{api}}/admin/support
GET {{api}}/admin/invoices

### 7. Backend Forwarding & Webhooks
GET {{api}}/forwarding-requests
GET {{api}}/forwarding-requests/usage
GET {{api}}/webhooks/gc
GET {{api}}/debug/whoami
GET {{api}}/debug/db-info

### 8. Backend POST Operations
POST {{api}}/support
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "subject": "Name change",
  "message": "Please update trading name."
}

### 9. Backend GDPR Export
POST {{api}}/gdpr-export
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "confirm": true
}

### 10. Backend Payment Redirect Flows
POST {{api}}/payments/redirect-flows
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "session_token": "demo"
}

### 11. Backend Mail Forwarding
POST {{api}}/mail/forward
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "mail_item_id": 1,
  "address": "{{forwardAddress}}"
}

### 12. Backend Admin Mail Bulk
POST {{api}}/admin/mail-bulk
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "ids": [1, 2, 3],
  "address": "{{forwardAddress}}"
}

### 13. Backend Webhooks
POST {{api}}/webhooks/sumsub
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "type": "applicantReviewed",
  "reviewStatus": "completed",
  "reviewResult": {
    "reviewAnswer": "GREEN"
  },
  "applicantId": "demo"
}

### 14. Backend GoCardless Webhook
POST {{api}}/webhooks-gc
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "events": [
    {
      "resource_type": "payments",
      "action": "confirmed",
      "links": {
        "payment": "PM123"
      }
    }
  ]
}

### 15. Backend Postmark Webhook
POST {{api}}/webhooks-postmark
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "RecordType": "Bounce",
  "Type": "HardBounce",
  "Email": "user@example.com"
}

### 16. Backend PATCH Operations
PATCH {{api}}/admin/support/1
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "status": "resolved"
}

### 17. Backend User Management
PATCH {{api}}/admin/users/1
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "role": "admin"
}

### 18. Backend Mail Item Management
PATCH {{api}}/admin/mail-items/1
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "status": "forwarded",
  "tag": "Priority"
}

### 19. Backend Plan Management
PATCH {{api}}/admin/plans/1
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "amount_pence": 999,
  "currency": "GBP"
}

### 20. Backend PUT Operations
PUT {{api}}/profile/address
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "line1": "1 Test St",
  "city": "Testville",
  "postcode": "AB1 2CD"
}

### 21. Backend KYC Status Update
PUT {{api}}/admin/users/1/kyc-status
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{
  "status": "approved"
}

### 22. Backend DELETE Operations
DELETE {{api}}/admin/mail-items/1
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

### 23. Backend Logout
POST {{api}}/auth/logout
Content-Type: application/json
X-CSRF-Token: {{$dotenv CSRF_TOKEN}}

{}

### ========================================
### BFF TESTS (Next.js :3000)
### ========================================

### 24. BFF CSRF
GET {{bff}}/auth/csrf

### 25. BFF Login
POST {{bff}}/auth/login
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "email": "{{adminEmail}}",
  "password": "{{adminPass}}"
}

### 26. BFF System Health
GET {{bff}}/ready
GET {{bff}}/health
GET {{bff}}/healthz
GET {{bff}}/metrics

### 27. BFF Core Business Logic
GET {{bff}}/plans
GET {{bff}}/profile
GET {{bff}}/auth/whoami
GET {{bff}}/billing
GET {{bff}}/billing/invoices
GET {{bff}}/payments
GET {{bff}}/payments/subscriptions/status

### 28. BFF Mail Operations
GET {{bff}}/mail-items
GET {{bff}}/mail-search?q=hmrc&limit=5
GET {{bff}}/notifications/unread

### 29. BFF Admin Operations
GET {{bff}}/admin/users?limit=20
GET {{bff}}/admin/mail-items?status=scanned&limit=20
GET {{bff}}/admin/plans
GET {{bff}}/admin/support
GET {{bff}}/admin/invoices

### 30. BFF Forwarding & Webhooks
GET {{bff}}/forwarding-requests
GET {{bff}}/forwarding-requests/usage
GET {{bff}}/webhooks/gc
GET {{bff}}/debug/whoami
GET {{bff}}/debug/db-info

### 31. BFF POST Operations
POST {{bff}}/support
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "subject": "Name change",
  "message": "Please update trading name."
}

### 32. BFF GDPR Export
POST {{bff}}/gdpr-export
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "confirm": true
}

### 33. BFF Payment Redirect Flows
POST {{bff}}/payments/redirect-flows
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "session_token": "demo"
}

### 34. BFF Mail Forwarding
POST {{bff}}/mail/forward
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "mail_item_id": 1,
  "address": "{{forwardAddress}}"
}

### 35. BFF Admin Mail Bulk
POST {{bff}}/admin/mail-bulk
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "ids": [1, 2, 3],
  "address": "{{forwardAddress}}"
}

### 36. BFF Webhooks
POST {{bff}}/webhooks/sumsub
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "type": "applicantReviewed",
  "reviewStatus": "completed",
  "reviewResult": {
    "reviewAnswer": "GREEN"
  },
  "applicantId": "demo"
}

### 37. BFF GoCardless Webhook
POST {{bff}}/webhooks-gc
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "events": [
    {
      "resource_type": "payments",
      "action": "confirmed",
      "links": {
        "payment": "PM123"
      }
    }
  ]
}

### 38. BFF Postmark Webhook
POST {{bff}}/webhooks-postmark
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "RecordType": "Bounce",
  "Type": "HardBounce",
  "Email": "user@example.com"
}

### 39. BFF PATCH Operations
PATCH {{bff}}/admin/support/1
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "status": "resolved"
}

### 40. BFF User Management
PATCH {{bff}}/admin/users/1
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "role": "admin"
}

### 41. BFF Mail Item Management
PATCH {{bff}}/admin/mail-items/1
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "status": "forwarded",
  "tag": "Priority"
}

### 42. BFF Plan Management
PATCH {{bff}}/admin/plans/1
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "amount_pence": 999,
  "currency": "GBP"
}

### 43. BFF PUT Operations
PUT {{bff}}/profile/address
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "line1": "1 Test St",
  "city": "Testville",
  "postcode": "AB1 2CD"
}

### 44. BFF KYC Status Update
PUT {{bff}}/admin/users/1/kyc-status
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{
  "status": "approved"
}

### 45. BFF DELETE Operations
DELETE {{bff}}/admin/mail-items/1
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

### 46. BFF Logout
POST {{bff}}/auth/logout
Content-Type: application/json
X-CSRF-Token: {{$dotenv BFF_CSRF_TOKEN}}

{}

### ========================================
### QUICK VERIFICATION COMMANDS
### ========================================

### Quick Health Check
GET {{api}}/ready
GET {{bff}}/ready

### Quick Auth Check
GET {{api}}/auth/whoami
GET {{bff}}/auth/whoami

### Quick Plans Check
GET {{api}}/plans
GET {{bff}}/plans
